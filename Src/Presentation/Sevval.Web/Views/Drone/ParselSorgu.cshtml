@{
    ViewData["Title"] = "Parsel Sorgulama";
    ViewData["DroneTab"] = "ParselSorgu";
}

@section style {
    <link rel="stylesheet" href="~/css/drone.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <style>
        :root {
            --parsel-ink: #0f172a;
            --parsel-muted: #6b7280;
            --parsel-border: #e2e8f0;
            --parsel-surface: #ffffff;
            --parsel-shell: #f8fafc;
            --parsel-hero: #0a1f3f;
            --parsel-accent: #0ea5e9;
            --parsel-accent-2: #f59e0b;
            --parsel-success: #22c55e;
            --parsel-danger: #ef4444;
            --parsel-ring: rgba(14, 165, 233, 0.18);
            --parsel-shadow: 0 18px 45px rgba(0, 9, 45, 0.16);
            --parsel-font: "Inter", "Plus Jakarta Sans", system-ui, -apple-system, sans-serif;
        }

        .parsel-hero {
            background: radial-gradient(120% 120% at 10% 10%, rgba(14, 165, 233, 0.28), transparent 45%), radial-gradient(110% 120% at 90% 20%, rgba(37, 99, 235, 0.25), transparent 55%), linear-gradient(135deg, #0c4da2, #0ea5e9);
            color: #e2e8f0;
            padding: 60px 0 48px;
            position: relative;
            overflow: hidden;
        }

        .parsel-hero::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(60% 80% at 70% 50%, rgba(255, 255, 255, 0.08), transparent 60%);
            pointer-events: none;
        }

        .parsel-hero .container { position: relative; z-index: 1; max-width: 1100px; }

        .parsel-hero h1 {
            font-family: var(--parsel-font);
            letter-spacing: -0.02em;
            font-weight: 800;
            color: #f8fafc;
        }

        .eyebrow {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: rgba(248, 250, 252, 0.7);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border: 1px solid rgba(255, 255, 255, 0.16);
            border-radius: 999px;
            backdrop-filter: blur(6px);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 13px;
            background: rgba(14, 165, 233, 0.12);
            color: #e0f2fe;
            border: 1px solid rgba(14, 165, 233, 0.35);
        }

        .pill.secondary {
            background: rgba(245, 158, 11, 0.12);
            color: #fef3c7;
            border-color: rgba(245, 158, 11, 0.32);
        }

        .hero-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 14px;
            margin-top: 20px;
        }

        .hero-stat {
            background: rgba(15, 23, 42, 0.38);
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 14px 16px;
            border-radius: 14px;
        }

        .hero-stat small { color: rgba(248, 250, 252, 0.65); }

        .status-card {
            background: var(--parsel-surface);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.24);
            color: var(--parsel-ink);
        }

        .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .live-dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: var(--parsel-success);
            box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            70% { box-shadow: 0 0 0 14px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .status-label {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 9px 12px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid var(--parsel-border);
            color: var(--parsel-muted);
            font-weight: 600;
        }

        .status-label[data-tone="error"] { color: var(--parsel-danger); border-color: rgba(239, 68, 68, 0.25); }
        .status-label[data-tone="success"] { color: var(--parsel-success); border-color: rgba(34, 197, 94, 0.25); }

        .status-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin: 14px 0;
        }

        .status-metrics .metric {
            padding: 12px;
            border: 1px dashed var(--parsel-border);
            border-radius: 12px;
            background: #f8fafc;
        }

        .parsel-shell {
            background: var(--drone-shell);
            padding: 32px 0 64px;
            margin-top: 0;
        }

        .parsel-shell .container {
            max-width: 1120px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding-left: 16px;
            padding-right: 16px;
        }

        .parsel-shell .drone-header {
            margin-bottom: 8px;
        }

        .surface {
            background: var(--parsel-surface);
            border: 1px solid var(--parsel-border);
            border-radius: 18px;
            box-shadow: var(--parsel-shadow);
            padding: 22px;
            height: 100%;
            width: 100%;
            max-width: 520px;
            margin: 0;
        }

        #form-panel {
            padding-left: 8px;
        }

        .surface h5, .surface h6 { color: var(--parsel-ink); font-weight: 800; }

        .section-head {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
        }

        .stepper {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--parsel-muted);
            font-size: 13px;
        }

        .stepper span {
            padding: 6px 10px;
            border-radius: 12px;
            background: #f8fafc;
            border: 1px solid var(--parsel-border);
            font-weight: 700;
            color: var(--parsel-ink);
        }

        .parsel-toast {
            position: fixed;
            right: 24px;
            bottom: 24px;
            background: #0f172a;
            color: #f8fafc;
            padding: 14px 18px;
            border-radius: 14px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.25);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            z-index: 9999;
            opacity: 0;
            transform: translateY(8px);
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .parsel-toast.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .parsel-toast .dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
        }

        .parsel-modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(15, 23, 42, 0.5);
            z-index: 9998;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .parsel-modal.is-visible {
            opacity: 1;
            pointer-events: auto;
        }

        .parsel-modal-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 20px 24px;
            box-shadow: 0 20px 50px rgba(15, 23, 42, 0.25);
            min-width: 280px;
            text-align: center;
        }

        .parsel-modal-title {
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 6px;
        }

        .parsel-modal-subtitle {
            font-size: 13px;
            color: #64748b;
        }

        .btn-ghost.is-loading,
        .btn-primary-parsel.is-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.85;
        }

        .btn-ghost.is-loading::after,
        .btn-primary-parsel.is-loading::after {
            content: "";
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.35);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }

        @@keyframes spin {
            to { transform: rotate(360deg); }
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px 16px;
            align-items: flex-start;
            width: 100%;
        }

        @@media (min-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
        }

        @@media (min-width: 992px) {
            .form-grid { grid-template-columns: 1fr; }
        }

        .action-cell {
            align-self: flex-end;
        }

        .form-label {
            font-weight: 700;
            color: var(--parsel-ink);
            margin-bottom: 6px;
        }

        .form-control, .form-select {
            border-radius: 14px;
            min-height: 48px;
            border: 1px solid var(--parsel-border);
            box-shadow: none;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            font-weight: 600;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--parsel-accent);
            box-shadow: 0 0 0 3px var(--parsel-ring);
        }

        .hint {
            color: var(--parsel-muted);
            font-size: 13px;
        }

        .btn-primary-parsel {
            background: linear-gradient(90deg, var(--parsel-accent), #2563eb);
            color: #fff;
            border: none;
            border-radius: 14px;
            padding: 12px 18px;
            font-weight: 800;
            min-width: 170px;
            position: relative;
            overflow: hidden;
            transition: transform 0.12s ease, box-shadow 0.12s ease;
        }

        .btn-primary-parsel:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(37, 99, 235, 0.26); }
        .btn-primary-parsel:active { transform: translateY(0); }
        .btn-primary-parsel:disabled { opacity: 0.7; cursor: not-allowed; }

        .btn-ghost {
            border: 1px solid var(--parsel-border);
            background: #fff;
            color: var(--parsel-ink);
            border-radius: 12px;
            padding: 11px 14px;
            font-weight: 700;
        }

        .btn-ghost:hover { background: #f8fafc; }

        .btn-loader {
            width: 16px;
            height: 16px;
            border-radius: 999px;
            border: 2px solid rgba(255, 255, 255, 0.55);
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        .btn-primary-parsel.is-loading .btn-loader { display: inline-block; }
        .btn-primary-parsel .btn-label { display: inline-flex; gap: 8px; align-items: center; }
        .btn-primary-parsel.is-loading .btn-label { opacity: 0.85; }

        @@keyframes spin {
            to { transform: rotate(360deg); }
        }

        .map-wrap {
            border: 1px solid var(--parsel-border);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            background: #eef2ff;
            width: 100%;
            aspect-ratio: 16 / 9;
            min-height: 320px;
            max-height: 620px;
        }

        .map-wrap.is-visible {
            opacity: 1;
            visibility: visible;
        }

        #parsel-map {
            position: absolute;
            inset: 0;
            height: 100%;
            width: 100%;
        }

        .map-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 14px;
        }

        .map-meta .item {
            border: 1px dashed var(--parsel-border);
            border-radius: 12px;
            padding: 12px;
            background: #f8fafc;
        }

        .map-meta strong { color: var(--parsel-ink); }

        .toggle-raw {
            color: var(--parsel-muted);
            font-weight: 700;
            cursor: pointer;
            border: none;
            background: transparent;
        }

        pre#parsel-result {
            background: #0f172a;
            color: #e2e8f0;
            border-radius: 12px;
            padding: 14px;
            max-height: 260px;
            overflow: auto;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .badge-soft {
            padding: 6px 10px;
            border-radius: 10px;
            background: rgba(14, 165, 233, 0.1);
            color: var(--parsel-ink);
            font-weight: 700;
            border: 1px solid rgba(14, 165, 233, 0.2);
        }

        .muted-list {
            display: grid;
            gap: 8px;
            color: var(--parsel-muted);
            font-size: 14px;
        }

        .d-none { display: none !important; }

        .map-surface { display: flex; width: 100%; }
        @@media (min-width: 992px) { .map-surface { display: flex; } }

        .parsel-layout {
            display: grid;
            gap: 28px;
            align-items: flex-start;
            width: 100%;
            justify-content: flex-start;
            justify-items: flex-start;
        }

        @@media (min-width: 992px) {
    .parsel-layout {
        grid-template-columns: 420px 1fr; /* form sabit, harita esnek */
        align-items: stretch; /* YÜKSEKLİK EŞİTLEME */
    }
}
.map-surface,
.map-surface .surface {
    max-width: none !important;
}

.map-wrap {
    height: 100%;
    min-height: unset;   /* eski min-height'i iptal */
    aspect-ratio: unset; /* 16/9'u iptal */
}
.parsel-shell .container {
    max-width: 100% !important;
}

        .map-only .parsel-layout {
            grid-template-columns: 1fr;
            justify-items: center;
        }

        .map-only #form-panel { display: none; }

        .map-only #map-surface {
            display: flex !important;
            max-width: 900px;
            width: 100%;
        }

        .map-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .map-actions .btn-primary-parsel {
            padding: 10px 16px;
            min-width: 0;
            font-size: 14px;
        }

        .map-actions .btn-primary-parsel,
        .map-actions .btn-ghost {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        @@media (max-width: 768px) {
            .parsel-hero { padding: 46px 0 36px; }
            .status-row { flex-direction: column; align-items: flex-start; }
            .section-head { flex-direction: column; }
        }
    </style>
}

<section class="parsel-shell">
    <div class="container">
        <div class="drone-header-row">
            <div class="drone-header">
                <div class="drone-title">Parsel Sorgula</div>
                <div class="drone-subtitle">Ada/parsel bazlı arama yapın, hızlıca drone video oluşturun.</div>
            </div>
            @await Html.PartialAsync("_DroneTabs")
        </div>
        <div class="parsel-layout">
            <div class="d-flex justify-content-center" id="form-panel">
                <div class="surface">
                    <div class="section-head">
                        <div>
                            <div class="text-uppercase text-muted fw-semibold small mb-1">Parsel Sorgu</div>
                        </div>
                        <div class="stepper">
                            <span>1</span> İlçe/Mahalle seçimi
                            <span>2</span> Ada-Parsel
                            <span>3</span> Polygon
                        </div>
                    </div>
                    <form id="parsel-form" class="form-grid">
                        <input type="hidden" id="mahalle-id-input" />
                        <div>
                            <label class="form-label">İl</label>
                            <select class="form-select" aria-label="İl seçiniz" id="il-select">
                                <option selected disabled>İl seçiniz</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">İlçe</label>
                            <select class="form-select" aria-label="İlçe seçiniz" id="ilce-select" disabled>
                                <option selected disabled>İlçe seçiniz</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Mahalle</label>
                            <select class="form-select" aria-label="Mahalle seçiniz" id="mahalle-select" disabled>
                                <option selected disabled>Mahalle seçiniz</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">Ada</label>
                            <input type="text" class="form-control" id="ada-input" placeholder="Örn: 123" autocomplete="off">
                        </div>
                        <div>
                            <label class="form-label">Parsel</label>
                            <input type="text" class="form-control" id="parsel-input" placeholder="Örn: 45" autocomplete="off">
                        </div>
                        <div class="action-cell">
                            <label class="form-label text-muted">Sorgu</label>
                            <button type="submit" class="btn-primary-parsel w-100" id="sorgula-btn">
                                <span class="btn-label"><i class="fa-solid fa-magnifying-glass"></i> Sorgula</span>
                                <span class="btn-loader" aria-hidden="true"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="d-flex justify-content-center map-surface" id="map-surface">
                <div class="surface w-100">
                    <div class="section-head">
                        <div class="map-actions">
                            <button type="button" class="btn-ghost" id="yeni-sorgu-btn" style="display:none;">Yeni sorgu</button>
                            <button type="button" class="btn-ghost" id="save-btn" style="display:none;">
                                <i class="fa-regular fa-bookmark me-2"> </i>Parseli Kaydet
                            </button>
                            <button type="button" class="btn-primary-parsel" id="video-btn" style="display:none;">
                                <i class="fa-solid fa-video me-2"></i> Video Oluştur
                            </button>
                        </div>
                    </div>
                    <div class="map-wrap">
                        <div id="parsel-map"></div>
                    </div>
                    <pre id="parsel-result" class="d-none mt-3"></pre>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const baseUrl = '/api/tkgm';
            const els = {
                il: document.getElementById('il-select'),
                ilce: document.getElementById('ilce-select'),
                mahalle: document.getElementById('mahalle-select'),
                ada: document.getElementById('ada-input'),
                parsel: document.getElementById('parsel-input'),
                mahalleId: document.getElementById('mahalle-id-input'),
                form: document.getElementById('parsel-form'),
                status: document.getElementById('status-text'),
                mapState: document.getElementById('map-state'),
                polygonState: document.getElementById('polygon-state'),
                link: document.getElementById('parsel-link'),
                tkgmOpen: document.getElementById('tkgm-open-btn'),
                resetBtn: document.getElementById('reset-btn'),
                result: document.getElementById('parsel-result'),
                rawToggle: document.getElementById('raw-toggle'),
                sorgulaBtn: document.getElementById('sorgula-btn'),
                mahalleChip: document.getElementById('mahalle-chip'),
                queryCount: document.getElementById('query-count'),
                lastQuery: document.getElementById('last-query'),
                selectedIl: document.getElementById('selected-il'),
                selectedIlce: document.getElementById('selected-ilce'),
                selectedMahalle: document.getElementById('selected-mahalle'),
                tkgmHint: document.getElementById('tkgm-link-hint'),
                mapWrap: document.querySelector('.map-wrap'),
                mapSurface: document.getElementById('map-surface'),
                formPanel: document.getElementById('form-panel'),
                shell: document.querySelector('.parsel-shell'),
                yeniSorgu: document.getElementById('yeni-sorgu-btn'),
                videoBtn: document.getElementById('video-btn'),
                saveBtn: document.getElementById('save-btn')
            };

            if (!els.form || !els.il || !els.ilce || !els.mahalle) {
                console.warn('Parsel sorgu form elemanları bulunamadı.');
                return;
            }

            const state = {
                tkgmUrl: '',
                map: null,
                polygonLayer: null,
                queryCount: 0,
                lastQuery: {
                    ada: '',
                    parsel: ''
                },
                parcelMeta: {
                    alan: null,
                    nitelik: '',
                    mevkii: ''
                },
                coordinates: [],
                selection: {
                    il: null,
                    ilce: null,
                    mahalle: null
                }
            };

            const setText = (el, text) => {
                if (el) el.textContent = text;
            };

            const setStatus = (text, tone = 'info') => {
                if (!els.status) return;
                els.status.textContent = text;
                els.status.dataset.tone = tone;
            };

            const showToast = (message) => {
                const existing = document.querySelector('.parsel-toast');
                if (existing) existing.remove();
                const toast = document.createElement('div');
                toast.className = 'parsel-toast';
                toast.innerHTML = `<span class="dot"></span><span>${message}</span>`;
                document.body.appendChild(toast);
                requestAnimationFrame(() => toast.classList.add('is-visible'));
                setTimeout(() => {
                    toast.classList.remove('is-visible');
                    setTimeout(() => toast.remove(), 200);
                }, 2000);
            };

            const showModal = (title, subtitle) => {
                const existing = document.querySelector('.parsel-modal');
                if (existing) existing.remove();
                const modal = document.createElement('div');
                modal.className = 'parsel-modal';
                modal.innerHTML = `
                    <div class="parsel-modal-card">
                        <div class="parsel-modal-title">${title}</div>
                        <div class="parsel-modal-subtitle">${subtitle}</div>
                    </div>
                `;
                document.body.appendChild(modal);
                requestAnimationFrame(() => modal.classList.add('is-visible'));
                return modal;
            };

            const setButtonLoading = (isLoading) => {
                if (!els.sorgulaBtn) return;
                els.sorgulaBtn.classList.toggle('is-loading', isLoading);
                els.sorgulaBtn.disabled = isLoading;
            };

            const setSummary = () => {
                setText(els.selectedIl, `İl: ${state.selection.il?.name ?? '—'}`);
                setText(els.selectedIlce, `İlçe: ${state.selection.ilce?.name ?? '—'}`);
                setText(els.selectedMahalle, `Mahalle: ${state.selection.mahalle?.name ?? '—'}`);
                setText(els.mahalleChip, `Mahalle kodu: ${state.selection.mahalle?.id ?? '—'}`);
            };

            const ensureMap = async () => {
                await ensureLeaflet();
                if (!state.map) {
                    state.map = L.map('parsel-map', {
                        zoomControl: false,
                        dragging: false,
                        scrollWheelZoom: false,
                        doubleClickZoom: false,
                        boxZoom: false,
                        keyboard: false,
                        tap: false,
                        touchZoom: false,
                        attributionControl: false
                    });
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        maxZoom: 19,
                        attribution: ''
                    }).addTo(state.map);
                    L.control.attribution({
                        position: 'bottomleft',
                        prefix: false
                    }).addTo(state.map).addAttribution('<span style="color:#ffd200;font-weight:600;">Powered by emlakcozum.com</span>');
                    state.map.setView([39.0, 35.0], 6);
                }
                els.mapWrap?.classList.add('is-visible');
            };

            const ensureLeaflet = () => {
                if (window.L) return Promise.resolve();
                return new Promise((resolve, reject) => {
                    const existing = document.getElementById('leaflet-js');
                    if (existing) {
                        existing.addEventListener('load', () => resolve());
                        existing.addEventListener('error', reject);
                        return;
                    }
                    const script = document.createElement('script');
                    script.id = 'leaflet-js';
                    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                    script.crossOrigin = '';
                    script.onload = () => resolve();
                    script.onerror = (e) => reject(e);
                    document.body.appendChild(script);
                });
            };

            const fetchJson = async (url) => {
                const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
                if (!res.ok) {
                    const err = new Error(res.statusText || 'İstek hatası');
                    err.status = res.status;
                    throw err;
                }
                return res.json();
            };

            const resetSelect = (selectEl, placeholder) => {
                selectEl.innerHTML = `<option selected disabled>${placeholder}</option>`;
            };

            const normalizeList = (raw) => {
                if (!raw) return [];
                if (Array.isArray(raw)) return raw;
                if (Array.isArray(raw.features)) return raw.features;
                const candidate = raw.data || raw.Data || raw.items || raw.Items || raw.result || raw.Result;
                if (Array.isArray(candidate)) return candidate;
                const values = Object.values(raw);
                return Array.isArray(values) ? values : [];
            };

            const pickProp = (obj, keys) => {
                for (const key of keys) {
                    if (obj && obj[key] !== undefined && obj[key] !== null) return obj[key];
                }
                return '';
            };

            const extractParcelMeta = (payload) => {
                const base = payload?.properties
                    || payload?.feature?.properties
                    || payload?.features?.[0]?.properties
                    || payload?.data?.properties
                    || payload?.data?.features?.[0]?.properties
                    || {};
                const alanRaw = pickProp(base, ['alan', 'Alan', 'alanMetrekare', 'alan_m2', 'm2', 'M2', 'area', 'Area']);
                const alan = alanRaw ? Number(alanRaw) : null;
                return {
                    alan: Number.isFinite(alan) ? alan : null,
                    nitelik: pickProp(base, ['nitelik', 'Nitelik', 'vasif', 'Vasif', 'niteligi']),
                    mevkii: pickProp(base, ['mevkii', 'Mevkii', 'mevki', 'Mevki', 'mevkiiAdi'])
                };
            };

            const normalizeGeometryPayload = (payload) => {
                if (!payload) return payload;
                const candidate = payload.data || payload.Data || payload.result || payload.Result || payload.response || payload.payload;
                if (candidate && (candidate.type || candidate.features || candidate.geometry)) {
                    return candidate;
                }
                return payload;
            };

            const findCoordRing = (value) => {
                if (!value) return [];
                if (Array.isArray(value)) {
                    if (value.length > 0 && Array.isArray(value[0]) && value[0].length >= 2) {
                        const looksLikeRing = value.every((pair) =>
                            Array.isArray(pair)
                            && pair.length >= 2
                            && Number.isFinite(Number(pair[0]))
                            && Number.isFinite(Number(pair[1]))
                        );
                        if (looksLikeRing) return value;
                    }
                    for (const item of value) {
                        const found = findCoordRing(item);
                        if (found.length) return found;
                    }
                    return [];
                }
                if (typeof value === 'object') {
                    for (const key of Object.keys(value)) {
                        const found = findCoordRing(value[key]);
                        if (found.length) return found;
                    }
                }
                return [];
            };

            const setSelectLoading = (selectEl, placeholder) => {
                resetSelect(selectEl, placeholder);
                const opt = document.createElement('option');
                opt.disabled = true;
                opt.selected = true;
                opt.textContent = 'Yükleniyor...';
                selectEl.appendChild(opt);
            };

            const loadIller = async () => {
                try {
                    setSelectLoading(els.il, 'İl seçiniz');
                    setStatus('İller yükleniyor...', 'info');
                    const raw = await fetchJson(`${baseUrl}/il`);
                    const data = normalizeList(raw);
                    resetSelect(els.il, 'İl seçiniz');
                    data.forEach((item) => {
                        const props = item.properties || item;
                        const id = pickProp(props, ['id', 'Id', 'ilId', 'IlId', 'ilKodu', 'IlKodu', 'kod', 'Kod']);
                        const name = pickProp(props, ['ad', 'Adi', 'ilAdi', 'IlAdi', 'name', 'Name', 'text', 'Text']);
                        if (!id || !name) return;
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.textContent = name;
                        els.il.appendChild(opt);
                    });
                    setStatus('Hazır.', 'success');
                } catch (err) {
                    console.error('İller alınamadı', err);
                    if (err.status === 403) {
                        setStatus('Günlük TKGM limitine takıldık (403). Lütfen bir süre sonra tekrar deneyin.', 'error');
                    } else {
                        setStatus('İl listesi alınamadı.', 'error');
                    }
                }
            };

            const loadIlceler = async (ilId) => {
                try {
                    setSelectLoading(els.ilce, 'İlçe seçiniz');
                    els.ilce.disabled = true;
                    els.mahalle.disabled = true;
                    setStatus('İlçeler yükleniyor...', 'info');
                    const raw = await fetchJson(`${baseUrl}/ilce/${encodeURIComponent(ilId)}`);
                    const data = normalizeList(raw);
                    resetSelect(els.ilce, 'İlçe seçiniz');
                    data.forEach((item) => {
                        const props = item.properties || item;
                        const id = pickProp(props, ['id', 'Id', 'ilceId', 'IlceId', 'ilceKodu', 'IlceKodu', 'kod', 'Kod']);
                        const name = pickProp(props, ['ad', 'Adi', 'ilceAdi', 'IlceAdi', 'name', 'Name', 'text', 'Text']);
                        if (!id || !name) return;
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.textContent = name;
                        els.ilce.appendChild(opt);
                    });
                    els.ilce.disabled = false;
                    setStatus('İlçeler hazır.', 'success');
                } catch (err) {
                    console.error('İlçeler alınamadı', err);
                    setStatus('İlçe listesi alınamadı.', 'error');
                }
            };

            const loadMahalleler = async (ilceId) => {
                try {
                    setSelectLoading(els.mahalle, 'Mahalle seçiniz');
                    els.mahalle.disabled = true;
                    setStatus('Mahalleler yükleniyor...', 'info');
                    const raw = await fetchJson(`${baseUrl}/mahalle/${encodeURIComponent(ilceId)}`);
                    const data = normalizeList(raw);
                    resetSelect(els.mahalle, 'Mahalle seçiniz');
                    data.forEach((item) => {
                        const props = item.properties || item;
                        const id = pickProp(props, ['id', 'Id', 'mahalleId', 'MahalleId', 'mahalleKodu', 'MahalleKodu', 'kod', 'Kod']);
                        const name = pickProp(props, ['ad', 'Adi', 'mahalleAdi', 'MahalleAdi', 'name', 'Name', 'text', 'Text']);
                        if (!id || !name) return;
                        const opt = document.createElement('option');
                        opt.value = id;
                        opt.textContent = name;
                        els.mahalle.appendChild(opt);
                    });
                    els.mahalle.disabled = false;
                    setStatus('Mahalleler hazır.', 'success');
                } catch (err) {
                    console.error('Mahalleler alınamadı', err);
                    setStatus('Mahalle listesi alınamadı.', 'error');
                }
            };

            els.il.addEventListener('change', () => {
                const selected = els.il.options[els.il.selectedIndex];
                state.selection.il = { code: selected?.value, name: selected?.textContent };
                state.selection.ilce = null;
                state.selection.mahalle = null;
                els.mahalleId.value = '';
                setSummary();
                resetSelect(els.ilce, 'İlçe seçiniz');
                resetSelect(els.mahalle, 'Mahalle seçiniz');
                els.ilce.disabled = true;
                els.mahalle.disabled = true;
                if (state.selection.il?.code) {
                    loadIlceler(state.selection.il.code);
                }
            });

            els.ilce.addEventListener('change', () => {
                const selected = els.ilce.options[els.ilce.selectedIndex];
                state.selection.ilce = { code: selected?.value, name: selected?.textContent };
                state.selection.mahalle = null;
                els.mahalleId.value = '';
                setSummary();
                resetSelect(els.mahalle, 'Mahalle seçiniz');
                els.mahalle.disabled = true;
                if (state.selection.ilce?.code) {
                    loadMahalleler(state.selection.ilce.code);
                }
            });

            els.mahalle.addEventListener('change', () => {
                const selected = els.mahalle.options[els.mahalle.selectedIndex];
                const id = selected?.value || '';
                els.mahalleId.value = id;
                state.selection.mahalle = { code: selected?.value, id, name: selected?.textContent };
                setSummary();
            });

            const renderPolygon = async (payload) => {
                try {
                    await ensureMap();
                    const normalized = normalizeGeometryPayload(payload);
                    const geometry = (() => {
                        if (!normalized) return null;
                        if (normalized.type === 'FeatureCollection') return normalized.features?.[0]?.geometry;
                        if (normalized.type === 'Feature') return normalized.geometry;
                        if (normalized.geometry) return normalized.geometry;
                        return normalized;
                    })();

                    const coords = geometry?.type === 'MultiPolygon'
                        ? geometry?.coordinates?.[0]?.[0]
                        : geometry?.coordinates?.[0] || findCoordRing(geometry || normalized);
                    if (!coords?.length) {
                        setStatus('Polygon verisi bulunamadı.', 'error');
                        setText(els.polygonState, 'Polygon alınamadı');
                        return;
                    }
                    state.parcelMeta = extractParcelMeta(payload);
                    state.coordinates = coords.map(([lng, lat]) => ({
                        latitude: Number(lat),
                        longitude: Number(lng)
                    }));
                    const latlngs = coords.map(([lng, lat]) => [lat, lng]);
                    if (state.polygonLayer) {
                        state.map.removeLayer(state.polygonLayer);
                    }
                    state.polygonLayer = L.polygon(latlngs, { color: '#2563eb', weight: 3, fillOpacity: 0.35 }).addTo(state.map);
                    state.map.fitBounds(state.polygonLayer.getBounds(), { padding: [32, 32] });
                    state.map.zoomOut(1);
                    setTimeout(() => state.map?.invalidateSize(), 80);
                    setText(els.polygonState, 'Polygon çizildi');
                    setText(els.mapState, 'Harita güncel');
                    setStatus('Polygon alındı.', 'success');
                } catch (err) {
                    console.error('Harita çizim hatası', err);
                    setText(els.polygonState, 'Harita çizilemedi');
                    setStatus('Polygon alındı, harita çizilemedi.', 'error');
                }
            };

            const buildTkgmUrl = () => {
                const ilName = state.selection.il?.name;
                const ilceName = state.selection.ilce?.name;
                const mahalleName = state.selection.mahalle?.name;
                if (!ilName || !ilceName || !mahalleName) return '';
                return `https://parselsorgu.tkgm.gov.tr/#ara/idari/${encodeURIComponent(ilName)}/${encodeURIComponent(ilceName)}/${encodeURIComponent(mahalleName)}`;
            };

            els.form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const ada = els.ada.value.trim();
                const parsel = els.parsel.value.trim();
                const mahalleId = els.mahalleId.value.trim();

                if (!state.selection.il || !state.selection.ilce || !state.selection.mahalle) {
                    setStatus('Lütfen il, ilçe ve mahalle seçin.', 'error');
                    return;
                }
                if (!mahalleId) {
                    setStatus('Mahalle kodu otomatik dolmalı.', 'error');
                    return;
                }
                if (!ada || !parsel) {
                    setStatus('Ada ve parsel zorunlu.', 'error');
                    return;
                }

                state.lastQuery = { ada, parsel };
                state.parcelMeta = { alan: null, nitelik: '', mevkii: '' };
                state.coordinates = [];
                state.tkgmUrl = buildTkgmUrl();
                if (state.tkgmUrl) {
                    if (els.link) {
                        els.link.style.display = 'inline-flex';
                        els.link.href = state.tkgmUrl;
                    }
                    if (els.tkgmOpen) els.tkgmOpen.disabled = false;
                    setText(els.tkgmHint, 'üretildi');
                    els.tkgmHint?.classList.add('text-success');
                }

                setStatus('Parsel bilgisi alınıyor...', 'info');
                setText(els.mapState, 'Bekleniyor');
                setText(els.polygonState, 'Polygon bekleniyor');
                els.result.classList.add('d-none');
                await ensureMap();
                if (els.videoBtn) els.videoBtn.style.display = 'none';
                if (els.saveBtn) els.saveBtn.style.display = 'none';
                setButtonLoading(true);

                try {
                    const data = await fetchJson(`${baseUrl}/parsel-geo?mahalleId=${encodeURIComponent(mahalleId)}&ada=${encodeURIComponent(ada)}&parsel=${encodeURIComponent(parsel)}`);
                    els.result.textContent = JSON.stringify(data, null, 2);
                    state.queryCount += 1;
                    setText(els.queryCount, state.queryCount.toString());
                    setText(els.lastQuery, `${ada} / ${parsel}`);
                    await renderPolygon(data);
                    if (els.videoBtn) els.videoBtn.style.display = 'inline-flex';
                    if (els.saveBtn) els.saveBtn.style.display = 'inline-flex';
                } catch (err) {
                    console.error('Polygon alınamadı', err);
                    setStatus('Polygon alınamadı.', 'error');
                    setText(els.polygonState, 'İstek başarısız');
                } finally {
                    setButtonLoading(false);
                }
            });

            if (els.tkgmOpen) {
                els.tkgmOpen.addEventListener('click', () => {
                    if (state.tkgmUrl) window.open(state.tkgmUrl, '_blank', 'noopener');
                });
            }

            if (els.resetBtn) {
                els.resetBtn.addEventListener('click', () => {
                    els.form.reset();
                    state.selection = { il: null, ilce: null, mahalle: null };
                    state.parcelMeta = { alan: null, nitelik: '', mevkii: '' };
                    state.coordinates = [];
                    els.mahalleId.value = '';
                    state.tkgmUrl = '';
                    if (els.link) els.link.style.display = 'none';
                    if (els.tkgmOpen) els.tkgmOpen.disabled = true;
                    setSummary();
                    setStatus('Form sıfırlandı.', 'info');
                    setText(els.polygonState, 'Polygon bekleniyor');
                    setText(els.mapState, 'Harita temizlendi');
                    els.mapWrap?.classList.add('is-visible');
                    if (els.videoBtn) els.videoBtn.style.display = 'none';
                    if (els.saveBtn) els.saveBtn.style.display = 'none';
                    if (state.map && state.polygonLayer) {
                        state.map.removeLayer(state.polygonLayer);
                        state.polygonLayer = null;
                    }
                });
            }

            if (els.yeniSorgu) {
                els.yeniSorgu.addEventListener('click', () => {
                    els.form?.reset();
                    state.selection = { il: null, ilce: null, mahalle: null };
                    state.parcelMeta = { alan: null, nitelik: '', mevkii: '' };
                    state.coordinates = [];
                    setSummary();
                    setText(els.polygonState, 'Polygon bekleniyor');
                    setText(els.mapState, 'Harita temizlendi');
                    if (els.link) els.link.style.display = 'none';
                    if (els.tkgmOpen) els.tkgmOpen.disabled = true;
                    if (els.videoBtn) els.videoBtn.style.display = 'none';
                    if (els.saveBtn) els.saveBtn.style.display = 'none';
                    if (state.map && state.polygonLayer) {
                        state.map.removeLayer(state.polygonLayer);
                        state.polygonLayer = null;
                    }
                });
            }

            if (els.rawToggle) {
                els.rawToggle.addEventListener('click', () => {
                    const isHidden = els.result.classList.contains('d-none');
                    els.result.classList.toggle('d-none', !isHidden);
                    els.rawToggle.innerHTML = isHidden
                        ? '<i class="fa-regular fa-eye-slash me-2"></i>JSON çıktısını gizle'
                        : '<i class="fa-regular fa-file-code me-2"></i>JSON çıktısını göster';
                });
            }

            if (els.saveBtn) {
                els.saveBtn.addEventListener('click', async () => {
                    const ada = state.lastQuery.ada || els.ada?.value.trim();
                    const parsel = state.lastQuery.parsel || els.parsel?.value.trim();
                    if (!state.selection.il || !state.selection.ilce || !state.selection.mahalle || !ada || !parsel) {
                        setStatus('Lütfen il/ilçe/mahalle ile ada-parsel seçin.', 'error');
                        return;
                    }

                    const payload = {
                        il: state.selection.il?.name,
                        ilce: state.selection.ilce?.name,
                        mahalle: state.selection.mahalle?.name,
                        mevkii: state.parcelMeta.mevkii || '',
                        ada,
                        parsel,
                        nitelik: state.parcelMeta.nitelik || '',
                        alan: state.parcelMeta.alan,
                        coordinates: state.coordinates || []
                    };

                    try {
                        els.saveBtn.disabled = true;
                        els.saveBtn.classList.add('is-loading');
                        setStatus('Parsel kaydediliyor...', 'info');
                        const response = await fetch('/api/drone/save-parcel', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await response.json().catch(() => null);
                        if (!response.ok || !data?.success) {
                            setStatus('Parsel kaydedilemedi.', 'error');
                            return;
                        }
                        setStatus('Parsel kaydedildi.', 'success');
                        const modal = showModal('Parsel kaydedildi', 'Kayıtlı parseller sayfasına yönlendiriliyorsunuz.');
                        setTimeout(() => {
                            if (modal) modal.remove();
                            window.location.href = '/Drone/KayitliParseller';
                        }, 1200);
                    } catch (err) {
                        console.error('Parsel kaydetme hatası', err);
                        setStatus('Parsel kaydedilemedi.', 'error');
                    } finally {
                        els.saveBtn.classList.remove('is-loading');
                        els.saveBtn.disabled = false;
                    }
                });
            }

            if (els.videoBtn) {
                els.videoBtn.addEventListener('click', () => {
                    const params = new URLSearchParams();
                    const addParam = (key, value) => {
                        if (value) params.set(key, value);
                    };
                    addParam('il', state.selection.il?.name);
                    addParam('ilce', state.selection.ilce?.name);
                    addParam('mahalle', state.selection.mahalle?.name);
                    addParam('ada', state.lastQuery.ada || els.ada?.value.trim());
                    addParam('parsel', state.lastQuery.parsel || els.parsel?.value.trim());
                    const query = params.toString();
                    window.location.href = query ? `/Drone/Olustur?${query}` : '/Drone/Olustur';
                });
            }

            loadIller();
            setSummary();
            ensureMap();
        });
    </script>
}
