@model List<Sevval.Domain.Entities.Comment>
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Tüm Yorumlar";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" type="text/css" href="~/css/yorumlar.css">
    <style>
        .post-ad-container {
            position: relative;
            display: inline-block;
        }

        .free-tag {
            position: absolute;
            top: -10px;
            left: -10px;
            background-color: #007bff;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            transform: rotate(-10deg);
            z-index: 1;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .pencere {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1100;
        }

        .pencere-icerik {
            background: linear-gradient(90deg, #1e88e5, #2196f3);
            width: 460px;
            height: 490px;
            display: flex;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
            padding: 20px;
            box-sizing: border-box;
            margin: auto;
        }

        .sol-bolum, .sag-bolum {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .sag-bolum {
            border-left: 2px solid #fff;
        }

        .baglanti {
            margin: 15px 0;
            padding: 15px 25px;
            background: #fff;
            color: #1e88e5;
            text-decoration: none;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: background 0.3s, transform 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            font-size: 18px;
            width: 80%;
        }

        .baglanti:hover {
            background: #f1f1f1;
            transform: translateY(-2px);
        }

        .kapat-buton {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            font-size: 30px;
            color: #fff;
            background: none;
            border: 2px solid #fff;
            text-align: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .kapat-buton:hover {
            color: #d32f2f;
            border-color: #d32f2f;
        }
    </style>
}

<!-- Pop-up Penceresi -->
<div id="popup-giris" class="pencere">
    <div class="pencere-icerik">
        <button class="kapat-buton" id="pencere-kapat">&times;</button>
        <div class="sol-bolum">
            <h2>Bireysel</h2>
            <a href="@Url.Action("Login", "Account")" class="baglanti">Giriş Yap</a>
            <a href="@Url.Action("Register", "Account")" class="baglanti">Üye Ol</a>
        </div>
        <div class="sag-bolum">
            <h2>Kurumsal</h2>
            <a href="@Url.Action("Login","Account" )" class="baglanti">Giriş Yap</a>
            <a href="@Url.Action("EstateRegister", "Account")" class="baglanti">Üye Ol</a>
        </div>
    </div>
</div>

<div class="comments-section">
    <h2>Tüm Yorumlar</h2>

    <div class="comments-container">
        @foreach (var comment in Model)
        {
            <div class="comment-card" id="comment-@comment.Id">
                @if (User.Identity.IsAuthenticated && 
                    (User.Identity.Name == "sftumen41@gmail.com" || User.Identity.Name == "exdel.txt@gmail.com"))
                {
                    <button class="comment-delete-btn-corner" onclick="deleteComment(@comment.Id)" type="button" title="Yorumu Sil">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                }
                <p class="comment-user">
                    <strong>@comment.UserFullName</strong>
                    <span class="comment-date">(@comment.CreatedAt.ToString("dd MMMM yyyy HH:mm", new System.Globalization.CultureInfo("tr-TR")))</span>
                </p>
                <p class="comment-content">@comment.Content</p>
                
                @if (User.Identity.IsAuthenticated && User.Identity.Name == "sftumen41@gmail.com" && !comment.IsApproved)
                {
                    <div class="comment-admin-actions">
                        <button class="comment-approve-btn" onclick="approveComment(@comment.Id)" type="button">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Onayla
                        </button>
                    </div>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('giris-buton')?.addEventListener('click', function (event) {
            event.preventDefault();
            document.getElementById('popup-giris').style.display = 'flex';
        });

        document.getElementById('popup-giris')?.addEventListener('click', function (event) {
            if (event.target === this) {
                this.style.display = 'none';
            }
        });

        document.getElementById('pencere-kapat')?.addEventListener('click', function () {
            document.getElementById('popup-giris').style.display = 'none';
        });

        async function deleteComment(commentId) {
            if (!confirm('Bu yorumu silmek istediğinizden emin misiniz?')) {
                return;
            }
            
            try {
                const response = await fetch('/Home/DeleteComment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'commentId=' + commentId
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const commentElement = document.getElementById('comment-' + commentId);
                    if (commentElement) {
                        commentElement.remove();
                    }
                    alert('Yorum başarıyla silindi.');
                } else {
                    alert('Hata: ' + (result.message || 'Yorum silinemedi.'));
                }
            } catch (error) {
                console.error('Silme hatası:', error);
                alert('Bir hata oluştu. Lütfen tekrar deneyin.');
            }
        }
        
        async function approveComment(commentId) {
            try {
                const response = await fetch('/Home/ApproveComment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'commentId=' + commentId
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const commentElement = document.getElementById('comment-' + commentId);
                    if (commentElement) {
                        const adminActions = commentElement.querySelector('.comment-admin-actions');
                        if (adminActions) {
                            adminActions.remove();
                        }
                    }
                    alert('Yorum başarıyla onaylandı.');
                } else {
                    alert('Hata: ' + (result.message || 'Yorum onaylanamadı.'));
                }
            } catch (error) {
                console.error('Onaylama hatası:', error);
                alert('Bir hata oluştu. Lütfen tekrar deneyin.');
            }
        }
    </script>
}