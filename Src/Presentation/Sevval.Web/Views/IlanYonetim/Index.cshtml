@model sevvalemlak.Dto.IlanYonetimDTO
@{
    ViewData["Title"] = "İlan Yönetimi";
    Layout = null;
}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Şevval Ofis</title>

    <!-- External CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
            --bs-blue: #0d6efd;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #eef5f9;
        }

        .page-header {
            background: linear-gradient(90deg, #0d6efd, #0d6efd);
            color: #fff;
            padding: 15px 30px;
        }

            .page-header .logo-details {
                display: flex;
                align-items: center;
            }

                .page-header .logo-details i {
                    font-size: 30px;
                    margin-right: 15px;
                }

            .page-header .logo_name {
                font-size: 24px;
                font-weight: 600;
            }

            .page-header .page-title {
                font-size: 22px;
                font-weight: 500;
                margin: 0;
            }

        .main-content {
            padding: 30px;
        }

        .card {
            border: 0;
            border-radius: 0.75rem;
        }

        .table-responsive {
            border-radius: 0.75rem;
        }

        .table {
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
        }

            .table thead th {
                background-color: var(--primary-color);
                color: white;
            }

                .table thead th:first-child {
                    border-top-left-radius: 0.5rem;
                }

                .table thead th:last-child {
                    border-top-right-radius: 0.5rem;
                }


            .table tbody tr:hover {
                background-color: #f1f5f9;
            }

            .table td, .table th {
                vertical-align: middle;
            }

        .ilan-thumbnail {
            width: 100px;
            height: 70px;
            object-fit: cover;
            border-radius: 0.5rem;
        }

        .ilan-title-link {
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 600;
        }

            .ilan-title-link:hover {
                text-decoration: underline;
            }

        .btn-group-sm .btn {
            font-size: 0.75rem;
        }

        .select2-container .select2-selection--single {
            height: 38px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }

        .select2-container--default .select2-selection--single, .form-control, .form-select {
            border-radius: 0.5rem;
        }

        .btn {
            border-radius: 0.5rem;
            font-weight: 500;
        }

        .pagination .page-link {
            border-radius: 0.5rem;
        }
    </style>
</head>
<body>
    <header class="page-header shadow-sm sticky-top">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="logo-details">
                <span class="logo_name">Şevval Ofis</span>
            </div>
            <h1 class="page-title d-none d-md-block">@ViewData["Title"]</h1>
            <a href="@Url.Action("Index", "SevvalOfis")" class="btn btn-outline-light"><i class="fa-solid fa-arrow-left me-2"></i>Panele Dön</a>
        </div>
    </header>

    <main class="main-content">
        <div class="container-fluid">
            <!-- Filtreleme Bölümü -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-filter me-2 text-primary"></i>Filtrele
                    </h5>
                </div>
                <div class="card-body">
                    <form asp-action="Index" method="get">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label for="ilanNo" class="form-label">İlan No</label>
                                <input type="text" class="form-control" id="ilanNo" name="ilanNo" value="@Model.IlanNo">
                            </div>
                            <div class="col-md-3">
                                <label for="firmaId" class="form-label">Firma</label>
                                <select class="form-select" id="firmaId" name="firmaId" data-placeholder="Tüm Firmalar">
                                    <option value=""></option>
                                    @foreach (var firma in Model.Firmalar.Where(f => !string.IsNullOrEmpty(f.CompanyName)).OrderBy(f => f.CompanyName))
                                    {
                                        <option value="@firma.Id" selected="@(Model.FirmaId == firma.Id)">@firma.CompanyName</option>
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="danismanEmail" class="form-label">Danışman</label>
                                <select class="form-select" id="danismanEmail" name="danismanEmail" disabled data-placeholder="Önce Firma Seçin">
                                    <option value=""></option>
                                </select>
                            </div>
@*                             <div class="col-md-2">
                                <label for="sehir" class="form-label">Şehir</label>
                                <input type="text" class="form-control" id="sehir" name="sehir" value="@Model.Sehir">
                            </div>
                            <div class="col-md-2">
                                <label for="ilce" class="form-label">İlçe</label>
                                <input type="text" class="form-control" id="ilce" name="ilce" value="@Model.Ilce">
                            </div>
                            <div class="col-md-4">
                                <label for="ilanSahibiArama" class="form-label">İlan Sahibi / Firma Adı</label>
                                <input type="text" class="form-control" id="ilanSahibiArama" name="ilanSahibiArama" value="@Model.IlanSahibiArama" placeholder="Ad, soyad veya firma adı...">
                            </div>
 *@                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100"><i class="fa-solid fa-magnifying-glass"></i> Ara</button>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <a asp-action="Index" class="btn btn-secondary w-100"><i class="fa-solid fa-rotate-left"></i> Temizle</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Toplu İşlem Bölümü -->
            <div id="bulk-actions" class="card shadow-sm mb-4" style="display: none;">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <span id="selection-count" class="fw-bold">0</span> ilan seçildi.
                    </div>
                    <div>
                        <button class="btn btn-primary" id="bulk-assign-btn"><i class="fa-solid fa-user-tag me-2"></i>Toplu Ata</button>
                        <button class="btn btn-danger" id="bulk-delete-btn"><i class="fa-solid fa-trash me-2"></i>Toplu Sil</button>
                    </div>
                </div>
            </div>

            <!-- İlan Tablosu -->
            <div class="card shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 50px;" class="text-center"><input class="form-check-input" type="checkbox" id="select-all-checkbox"></th>
                                <th scope="col" style="width: 120px;">Görsel</th>
                                <th scope="col">İlan Bilgileri</th>
                                <th scope="col" style="width: 150px;">Fiyat</th>
                                <th scope="col">Sahip</th>
                                <th scope="col">Firma</th>
                                <th scope="col" class="text-center" style="width: 200px;">İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Ilanlar)
                            {
                                <tr>
                                    <td class="text-center"><input class="form-check-input row-checkbox" type="checkbox" value="@item.Ilan.Id"></td>
                                    <td>
                                        <img src="@(item.VitrinFotografi != null ? "https://www.sevval.com" + item.VitrinFotografi.Url : "https://placehold.co/100x70/EFEFEF/AAAAAA?text=N/A")"
                                             class="ilan-thumbnail" alt="@item.Ilan.Title">
                                    </td>
                                    <td>
                                        <a href="@Url.Action("ilansayfasi", "Ilan", new { id = item.Ilan.Id })" target="_blank" class="ilan-title-link">@item.Ilan.Title</a>
                                        <div class="text-muted small">ID: @item.Ilan.Id | @item.Ilan.sehir / @item.Ilan.semt</div>
                                    </td>
                                    <td class="fw-bold text-danger">@item.Ilan.Price.ToString("N0") TL</td>
                                    <td>
                                        @if (item.IlanSahibi != null)
                                        {
                                            <span>@item.IlanSahibi.FirstName @item.IlanSahibi.LastName</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Bilinmiyor</span>
                                        }
                                    </td>
                                    <td><span class="badge bg-secondary">@item.FirmaAdi</span></td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <a href="@Url.Action("Edit", "Ilan", new { id = item.Ilan.Id })" class="btn btn-outline-secondary" title="Düzenle"><i class="fa-solid fa-pencil"></i></a>
                                            <button class="btn btn-outline-primary btn-ata" data-id="@item.Ilan.Id" title="Ata"><i class="fa-solid fa-user-tag"></i></button>
                                            <button class="btn btn-outline-danger btn-sil" data-id="@item.Ilan.Id" title="Sil"><i class="fa-solid fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Sayfalama -->
            @if (Model.TotalPages > 1)
            {
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        <!-- İlk Sayfa -->
                        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = 1, ilanNo = Model.IlanNo, firmaId = Model.FirmaId, danismanEmail = Model.DanismanEmail, sehir = Model.Sehir, ilce = Model.Ilce, ilanSahibiArama = Model.IlanSahibiArama })">İlk</a>
                        </li>
                        <!-- Önceki Sayfa -->
                        <li class="page-item @(!Model.HasPreviousPage ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage - 1, ilanNo = Model.IlanNo, firmaId = Model.FirmaId, danismanEmail = Model.DanismanEmail, sehir = Model.Sehir, ilce = Model.Ilce, ilanSahibiArama = Model.IlanSahibiArama })">Önceki</a>
                        </li>

                        @{
                            int totalPages = Model.TotalPages;
                            int currentPage = Model.CurrentPage;
                            int visiblePages = 5;
                            int startPage = Math.Max(1, currentPage - 2);
                            int endPage = Math.Min(totalPages, currentPage + 2);

                            if (startPage == 1)
                            {
                                endPage = Math.Min(totalPages, visiblePages);
                            }
                            if (endPage == totalPages)
                            {
                                startPage = Math.Max(1, totalPages - visiblePages + 1);
                            }
                        }

                        @if (startPage > 1)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }

                        @for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { page = i, ilanNo = Model.IlanNo, firmaId = Model.FirmaId, danismanEmail = Model.DanismanEmail, sehir = Model.Sehir, ilce = Model.Ilce, ilanSahibiArama = Model.IlanSahibiArama })">@i</a>
                            </li>
                        }

                        @if (endPage < totalPages)
                        {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        }

                        <!-- Sonraki Sayfa -->
                        <li class="page-item @(!Model.HasNextPage ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = Model.CurrentPage + 1, ilanNo = Model.IlanNo, firmaId = Model.FirmaId, danismanEmail = Model.DanismanEmail, sehir = Model.Sehir, ilce = Model.Ilce, ilanSahibiArama = Model.IlanSahibiArama })">Sonraki</a>
                        </li>
                        <!-- Son Sayfa -->
                        <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { page = Model.TotalPages, ilanNo = Model.IlanNo, firmaId = Model.FirmaId, danismanEmail = Model.DanismanEmail, sehir = Model.Sehir, ilce = Model.Ilce, ilanSahibiArama = Model.IlanSahibiArama })">Son</a>
                        </li>
                    </ul>
                </nav>
            }
        </div>
    </main>
    <!-- Atama Modalı -->
    <div class="modal fade" id="ataModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">İlan Ata</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalIlanId" />
                    <div class="mb-3">
                        <label for="modalFirmaSelect" class="form-label">1. Firma Seçin</label>
                        <select class="form-select" id="modalFirmaSelect">
                            <option value="">Firma seçiniz...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="modalDanismanSelect" class="form-label">2. Danışman Seçin</label>
                        <select class="form-select" id="modalDanismanSelect" disabled>
                            <option value="">Önce firma seçiniz...</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="modalAtaButton" disabled>Atamayı Tamamla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Onay Modalı -->
    <div class="modal fade" id="onayModal" tabindex="-1" aria-labelledby="onayModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="onayModalTitle"><i class="fa-solid fa-circle-question me-2"></i>Onay Gerekiyor</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="onayModalMesaj"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" id="onayModalOnaylaButton">Evet, Onayla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bilgi/Sonuç Modalı -->
    <div class="modal fade" id="bilgiModal" tabindex="-1" aria-labelledby="bilgiModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header text-white" id="bilgiModalHeader">
                    <h5 class="modal-title" id="bilgiModalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="bilgiModalMesaj" class="mb-0"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            const onayModal = new bootstrap.Modal(document.getElementById('onayModal'));
            const bilgiModal = new bootstrap.Modal(document.getElementById('bilgiModal'));

            // Bilgi/Sonuç Modalı için genel bir fonksiyon
            function showInfoModal(message, type = 'info') {
                const modalTitle = $('#bilgiModalTitle');
                const modalHeader = $('#bilgiModalHeader');
                const modalMessage = $('#bilgiModalMesaj');

                modalMessage.text(message);

                // Reset header class
                modalHeader.removeClass('bg-success bg-danger bg-warning bg-primary');

                switch (type) {
                    case 'success':
                        modalTitle.html('<i class="fa-solid fa-circle-check me-2"></i>Başarılı');
                        modalHeader.addClass('bg-success');
                        break;
                    case 'error':
                        modalTitle.html('<i class="fa-solid fa-circle-xmark me-2"></i>Hata');
                        modalHeader.addClass('bg-danger');
                        break;
                    case 'warning':
                        modalTitle.html('<i class="fa-solid fa-triangle-exclamation me-2"></i>Uyarı');
                        modalHeader.addClass('bg-warning text-dark'); // Sarı arkaplan için
                        break;
                    default:
                        modalTitle.html('<i class="fa-solid fa-circle-info me-2"></i>Bilgi');
                        modalHeader.addClass('bg-primary');
                        break;
                }
                bilgiModal.show();
            }


            // Onay Modalı için genel bir fonksiyon
            function showConfirmationModal(message, onConfirm) {
                $('#onayModalMesaj').text(message);
                $('#onayModalOnaylaButton').off('click').on('click', function () {
                    onayModal.hide();
                    onConfirm();
                });
                onayModal.show();
            }

            // Select2 kütüphanesini filtreleme dropdownlarına uygula
            $('#firmaId').select2({
                placeholder: "Tüm Firmalar",
                allowClear: true
            });

            const danismanSelect = $('#danismanEmail').select2({
                placeholder: "Önce Firma Seçin",
                allowClear: true
            });

            function loadDanismanlarForFilter(firmaId) {
                const selectedDanisman = "@Model.DanismanEmail";
                danismanSelect.html('<option value=""></option>').prop('disabled', true).trigger('change');

                if(!firmaId) {
                     danismanSelect.select2({ placeholder: "Önce Firma Seçin" });
                     return;
                }

                danismanSelect.select2({ placeholder: "Yükleniyor..." });

                 $.get('@Url.Action("GetDanismanlarForFirma")', { firmaId: firmaId }, function (danismanlar) {
                    danismanSelect.prop('disabled', false);
                    danismanSelect.select2({ placeholder: "Tüm Danışmanlar" });

                    danismanlar.forEach(function (danisman) {
                        const isSelected = danisman.email === selectedDanisman;
                        const newOption = new Option(danisman.name, danisman.email, isSelected, isSelected);
                        danismanSelect.append(newOption);
                    });
                    danismanSelect.trigger('change');
                });
            }

            // Sayfa yüklendiğinde mevcut firma seçiliyse danışmanları yükle
            const initialFirmaId = $('#firmaId').val();
            if(initialFirmaId){
                loadDanismanlarForFilter(initialFirmaId);
            }

            $('#firmaId').on('change', function(){
                const firmaId = $(this).val();
                loadDanismanlarForFilter(firmaId);
            });


            // Tekli Silme işlemi
            $('.btn-sil').on('click', function () {
                const ilanId = $(this).data('id');
                const message = ilanId + ' numaralı ilanı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.';

                showConfirmationModal(message, function() {
                    $.post('@Url.Action("Sil")', { ilanId: ilanId }, function (response) {
                        if (response.success) {
                            showInfoModal(response.message, 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showInfoModal('Hata: ' + response.message, 'error');
                        }
                    });
                });
            });

            // Atama modalı işlemleri
            const ataModal = new bootstrap.Modal(document.getElementById('ataModal'));

            function openAtaModal(ilanIds) {
                 $('#modalIlanId').val(ilanIds.join(','));

                const firmaSelect = $('#modalFirmaSelect');
                firmaSelect.html('<option value="">Yükleniyor...</option>').prop('disabled', true);
                $('#modalDanismanSelect').html('<option value="">Önce firma seçiniz...</option>').prop('disabled', true);
                $('#modalAtaButton').prop('disabled', true);

                $.get('@Url.Action("GetFirmalar")', function (firmalar) {
                    firmaSelect.html('<option value="">Firma seçiniz...</option>');
                    firmalar.forEach(function (firma) {
                        if(firma.name){
                             firmaSelect.append(new Option(firma.name, firma.id));
                        }
                    });
                    firmaSelect.prop('disabled', false);
                });

                ataModal.show();
            }

            // Tekli "Ata" butonu
            $('.btn-ata').on('click', function () {
                const ilanId = $(this).data('id');
                openAtaModal([ilanId]);
            });

            // Firma seçildiğinde danışmanları yükle (Modal içinde)
            $('#modalFirmaSelect').on('change', function () {
                const firmaId = $(this).val();
                const danismanSelect = $('#modalDanismanSelect');
                $('#modalAtaButton').prop('disabled', true);

                if (!firmaId) {
                    danismanSelect.html('<option value="">Önce firma seçiniz...</option>').prop('disabled', true);
                    return;
                }

                danismanSelect.html('<option value="">Yükleniyor...</option>').prop('disabled', true);

                $.get('@Url.Action("GetDanismanlarForFirma")', { firmaId: firmaId }, function (danismanlar) {
                    danismanSelect.html('<option value="">Danışman seçiniz...</option>');
                    danismanlar.forEach(function (danisman) {
                        danismanSelect.append(new Option(danisman.name, danisman.email));
                    });
                    danismanSelect.prop('disabled', false);
                });
            });

            // Danışman seçildiğinde Ata butonunu aktif et
            $('#modalDanismanSelect').on('change', function () {
                const danismanEmail = $(this).val();
                $('#modalAtaButton').prop('disabled', !danismanEmail);
            });

            // Atamayı Tamamla (Modal)
            $('#modalAtaButton').on('click', function () {
                const danismanEmail = $('#modalDanismanSelect').val();
                const ilanIdsString = $('#modalIlanId').val();
                const ilanIds = ilanIdsString.split(',').map(id => parseInt(id.trim()));

                if (!danismanEmail || ilanIds.length === 0) {
                    showInfoModal('Lütfen bir danışman seçin.', 'warning');
                    return;
                }

                const isBulk = ilanIds.length > 1;
                const actionUrl = isBulk ? '@Url.Action("TopluAta")' : '@Url.Action("Ata")';
                const postData = isBulk ? { ilanIds: ilanIds, danismanEmail: danismanEmail } : { ilanId: ilanIds[0], danismanEmail: danismanEmail };
                const message = ilanIds.length + ' ilanı seçilen danışmana atamak istediğinizden emin misiniz?';

                showConfirmationModal(message, function() {
                     $.ajax({
                        url: actionUrl,
                        type: 'POST',
                        data: postData,
                        success: function (response) {
                             if (response.success) {
                                ataModal.hide();
                                showInfoModal(response.message, 'success');
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showInfoModal('Hata: ' + response.message, 'error');
                            }
                        },
                        error: function(){
                             showInfoModal('Atama işlemi sırasında bir sunucu hatası oluştu.', 'error');
                        }
                    });
                });
            });


            // --- TOPLU İŞLEM SCRIPTLERI ---
            const bulkActionsPanel = $('#bulk-actions');
            const selectionCountSpan = $('#selection-count');
            const selectAllCheckbox = $('#select-all-checkbox');
            const rowCheckboxes = $('.row-checkbox');
            const bulkDeleteBtn = $('#bulk-delete-btn');
            const bulkAssignBtn = $('#bulk-assign-btn');

            function updateBulkActionsPanel() {
                const selectedCount = rowCheckboxes.filter(':checked').length;
                selectionCountSpan.text(selectedCount);

                if (selectedCount > 0) {
                    bulkActionsPanel.slideDown();
                } else {
                    bulkActionsPanel.slideUp();
                }
            }

            selectAllCheckbox.on('change', function () {
                rowCheckboxes.prop('checked', $(this).prop('checked'));
                updateBulkActionsPanel();
            });

            rowCheckboxes.on('change', function () {
                if (!$(this).prop('checked')) {
                    selectAllCheckbox.prop('checked', false);
                } else {
                    if (rowCheckboxes.filter(':checked').length === rowCheckboxes.length) {
                        selectAllCheckbox.prop('checked', true);
                    }
                }
                updateBulkActionsPanel();
            });

            // Toplu Silme
            bulkDeleteBtn.on('click', function () {
                const selectedIds = rowCheckboxes.filter(':checked').map(function () {
                    return parseInt($(this).val());
                }).get();

                if (selectedIds.length === 0) {
                    showInfoModal('Lütfen silmek için en az bir ilan seçin.', 'warning');
                    return;
                }
                const message = selectedIds.length + ' ilanı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.';

                showConfirmationModal(message, function() {
                     $.ajax({
                        url: '@Url.Action("TopluSil")',
                        type: 'POST',
                        data: { ilanIds: selectedIds },
                        success: function (response) {
                             if (response.success) {
                                showInfoModal(response.message, 'success');
                                setTimeout(() => location.reload(), 1500);
                            } else {
                                showInfoModal('Hata: ' + response.message, 'error');
                            }
                        },
                        error: function(){
                             showInfoModal('Toplu silme işlemi sırasında bir sunucu hatası oluştu.', 'error');
                        }
                    });
                });
            });

            // Toplu Atama butonu
            bulkAssignBtn.on('click', function() {
                const selectedIds = rowCheckboxes.filter(':checked').map(function () {
                    return parseInt($(this).val());
                }).get();

                if (selectedIds.length === 0) {
                    showInfoModal('Lütfen atamak için en az bir ilan seçin.', 'warning');
                    return;
                }

                openAtaModal(selectedIds);
            });
        });
    </script>
</body>
</html>

