@model List<Sevval.Domain.Entities.BireyselIlanTakibi>
@{
    ViewBag.Title = "Bireysel İlan Takip";
    Layout = "_Layout";
    ViewData["HideFooter"] = true;
}

@section Styles {
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="~/css/IlanTakip.css" rel="stylesheet" />
    <style>
        .cell-data { display: inline-block; }
        .edit-icon { margin-left: 5px; cursor: pointer; }
        .save-icon { margin-left: 5px; cursor: pointer; color: green; }
        .cancel-icon { margin-left: 5px; cursor: pointer; color: red; }
        .input-field { display: none; width: auto; }
        .ilan-girildi-mi-icon { margin-left: 5px; }
    </style>
}

<div class="container my-5">
    <h2 class="text-center mb-4">@ViewData["Title"]</h2>
    <div class="text-center mt-4">
        <button id="btnYeniKayit" class="btn btn-primary btn-lg me-2">Yeni Kayıt Ekle</button>
        <button id="btnAnaSayfa" class="btn btn-primary btn-lg me-2">Ana Sayfaya Dön</button>
        <button id="btnExcelIndir" class="btn btn-success btn-lg">Excel Olarak İndir</button>
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center mt-4">Henüz kayıtlı ilan bulunmamaktadır.</div>
    }
    else
    {
        <div class="table-title-container text-center mb-3 mt-4">
            <div class="table-title">Bireysel İlan Takip</div>
        </div>
        <div class="table-responsive modern-table-wrapper">
            <table class="table modern-table">
                <thead class="sticky-header">
                    <tr>
                        <th class="number-column">No</th>
                        <th>Kategori</th><th>İsim</th><th>Cep Tel.</th><th>İl</th><th>İlçe</th><th>Mahalle/Köy</th>
                        <th>Ada</th><th>Parsel</th><th>M²</th><th>Oda Sayısı</th><th>Bina Yaşı</th><th>Bina Kat Sayısı</th>
                        <th>Bulunduğu Kat</th><th>Isıtma Sistemi</th><th>Balkon</th><th>İmar</th><th>Tapu</th><th>İlan No</th>
                        <th>Eline İstenen Fiyat</th><th>İlan Fiyatı</th><th>Referans</th><th>İlan Girildi Mi?</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = Model.Count - 1; i >= 0; i--)
                    {
                        var item = Model[i];
                        <tr>
                            <td class="number-column">@((i + 1))</td>
                            @foreach (var field in new[] { "Kategori", "Isim", "CepTel", "Il", "Ilce", "MahalleKoy", "Ada", "Parsel", "Metrekare", "OdaSayisi", "BinaYasi", "BinaKatSayisi", "BulunduguKat", "IsitmaSistemi", "Balkon", "Imar", "Tapu", "IlanNo", "Fiyat", "IlanFiyati", "Referans" })
                            {
                                var value = item.GetType().GetProperty(field)?.GetValue(item)?.ToString() ?? "";
                                <td data-field="@field" data-record="@item.Id">
                                    <span class="cell-data">@value</span>
                                    <i class="bi bi-pencil edit-icon"></i>
                                </td>
                            }
                            <td data-field="IlanGirildiMi" data-record="@item.Id">
                                <span class="cell-data">
                                    @if (string.IsNullOrEmpty(item.IlanGirildiMi))
                                    { <span>X</span> }
                                    else
                                    { @item.IlanGirildiMi <i class="bi bi-check-circle-fill text-success ilan-girildi-mi-icon"></i> }
                                </span>
                                <i class="bi bi-pencil edit-icon"></i>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Modal: Değer Güncelle -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title" id="editModalLabel">Değer Güncelle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body"><input type="text" id="newValue" class="form-control" placeholder="Yeni değeri girin"></div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button><button type="button" id="saveBtn" class="btn btn-primary">Kaydet</button></div>
        </div>
    </div>
</div>

<!-- Yeni Kayıt Formu Modal -->
<div class="modal fade" id="yeniKayitModal" tabindex="-1" aria-labelledby="yeniKayitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content modern-modal">
            <div class="modal-header"><h4 class="modal-title" id="yeniKayitModalLabel">Yeni Kayıt Formu</h4><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="kayitFormu" method="post" asp-action="Create">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="kategori" class="form-label">Kategori</label>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary konut-secim-btn" id="konutSec">Konut</button>
                                <button type="button" class="btn btn-outline-primary konut-secim-btn" id="turistikTesisSec">Turistik Tesis</button>
                                <button type="button" class="btn btn-outline-primary konut-secim-btn" id="isYeriSec">İş Yeri</button>
                            </div>
                            <div class="d-flex gap-2 mt-2">
                                <button type="button" class="btn btn-outline-primary arazi-secim-btn" id="arsaSec">Arsa</button>
                                <button type="button" class="btn btn-outline-primary arazi-secim-btn" id="tarlaSec">Tarla</button>
                                <button type="button" class="btn btn-outline-primary arazi-secim-btn" id="bahceSec">Bahçe</button>
                                <input type="hidden" name="Kategori" id="kategoriInput" required>
                            </div>
                        </div>
                        <!-- Konut Form Alanları -->
                        <div id="konutFormu" class="row g-3">
                            <div class="col-md-4"><label class="form-label">İsim</label><input type="text" name="Isim" class="form-control" id="isim" required></div>
                            <div class="col-md-4"><label class="form-label">Cep Tel.</label><input type="text" name="CepTel" class="form-control" id="ceptel" required></div>
                            <div class="col-md-4"><label class="form-label">İl</label><select name="Il" class="form-control" id="il" required><option value="">İl Seçiniz</option></select></div>
                            <div class="col-md-4"><label class="form-label">İlçe</label><select name="Ilce" class="form-control" id="ilce"><option value="">İlçe Seçiniz</option></select></div>
                            <div class="col-md-4"><label class="form-label">Mahalle/Köy</label><select name="MahalleKoy" class="form-control" id="mahalle"><option value="">Mahalle/Köy Seçiniz</option></select></div>
                            <div class="col-md-4"><label class="form-label">Oda Sayısı</label><input type="number" name="OdaSayisi" class="form-control" id="odaSayisi"></div>
                            <div class="col-md-4"><label class="form-label">Bina Yaşı</label><input type="number" name="BinaYasi" class="form-control" id="binaYasi"></div>
                            <div class="col-md-4"><label class="form-label">Bina Kat Sayısı</label><input type="number" name="BinaKatSayisi" class="form-control" id="binaKatSayisi"></div>
                            <div class="col-md-4"><label class="form-label">Bulunduğu Kat</label><input type="number" name="BulunduguKat" class="form-control" id="bulunduguKat"></div>
                            <div class="col-md-4"><label class="form-label">Isıtma Sistemi</label><input type="text" name="IsitmaSistemi" class="form-control" id="isitmaSistemi"></div>
                            <div class="col-md-4"><label class="form-label">Balkon</label><select name="Balkon" class="form-control" id="balkon"><option value="">Seçiniz</option><option value="Var">Var</option><option value="Yok">Yok</option></select></div>
                        </div>
                        <!-- Arazi Form Alanları -->
                        <div id="araziFormu" class="row g-3" style="display: none;">
                            <div class="col-md-4"><label class="form-label">İsim</label><input type="text" name="Isim" class="form-control" id="isimArazi" required></div>
                            <div class="col-md-4"><label class="form-label">Cep Tel.</label><input type="text" name="CepTel" class="form-control" id="ceptelArazi" required></div>
                            <div class="col-md-4"><label class="form-label">İl</label><select name="Il" class="form-control" id="ilArazi" required><option value="">İl Seçiniz</option></select></div>
                            <div class="col-md-4"><label class="form-label">İlçe</label><select name="Ilce" class="form-control" id="ilceArazi"><option value="">İlçe Seçiniz</option></select></div>
                            <div class="col-md-4"><label class="form-label">Mahalle/Köy</label><select name="MahalleKoy" class="form-control" id="mahalleArazi"><option value="">Mahalle/Köy Seçiniz</option></select></div>
                            <div class="col-md-4"><label class="form-label">Ada</label><input type="text" name="Ada" class="form-control" id="ada"></div>
                            <div class="col-md-4"><label class="form-label">Parsel</label><input type="text" name="Parsel" class="form-control" id="parsel"></div>
                        </div>
                        <!-- Ortak Alanlar -->
                        <div class="row g-3">
                            <div class="col-md-4"><label class="form-label">M²</label><input type="text" name="Metrekare" class="form-control" id="metrekare"></div>
                            <div class="col-md-4"><label class="form-label">İmar</label><input type="text" name="Imar" class="form-control" id="imar"></div>
                            <div class="col-md-4"><label class="form-label">Tapu</label><input type="text" name="Tapu" class="form-control" id="tapu"></div>
                            <div class="col-md-4"><label class="form-label">İlan No</label><input type="text" name="IlanNo" class="form-control" id="ilanNo"></div>
                            <div class="col-md-4"><label class="form-label">Eline İstediği Fiyat</label><input type="text" name="Fiyat" class="form-control" id="fiyat"></div>
                            <div class="col-md-4"><label class="form-label">İlan Fiyatı</label><input type="text" name="IlanFiyati" class="form-control" id="IlanFiyati"></div>
                            <div class="col-md-4">
                                <label class="form-label">Referans</label>
                                <select name="Referans" class="form-select" id="referans" required>
                                    <option value="">Seçiniz</option>
                                    @if (ViewBag.ReferansOptions != null) 
                                    { 
                                        foreach (var item in ViewBag.ReferansOptions) 
                                        { 
                                            var val = item.GetType().GetProperty("Value")?.GetValue(item)?.ToString() ?? "";
                                            var txt = item.GetType().GetProperty("Text")?.GetValue(item)?.ToString() ?? "";
                                            <option value="@val">@txt</option> 
                                        } 
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer modern-modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button><button type="submit" class="btn btn-success" id="kaydetBtn">Kaydet</button></div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.getElementById('btnAnaSayfa').addEventListener('click', function () { window.location.href = '/'; });
        document.getElementById('btnExcelIndir').addEventListener('click', function () { window.location.href = '/IlanTakip/ExportToExcel'; });

        var currentRecordId, currentField;
        $(document).ready(function(){
            $('.edit-icon').on('click', function(event){
                event.stopPropagation();
                var cell = $(this).closest('td');
                currentRecordId = cell.data('record');
                currentField = cell.data('field');
                var currentValue = cell.find('.cell-data').text().trim();
                $('#newValue').val(currentValue);
                new bootstrap.Modal(document.getElementById('editModal')).show();
            });

            $('#saveBtn').on('click', function(){
                var newValue = $('#newValue').val();
                $.ajax({
                    url: '@Url.Action("UpdateCell", "IlanTakip")',
                    type: 'POST',
                    data: { id: currentRecordId, fieldName: currentField, newValue: newValue },
                    success: function(response){
                        if(response.success){
                            $('td[data-record="'+currentRecordId+'"][data-field="'+currentField+'"] .cell-data').text(newValue);
                            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                        } else { alert('Güncelleme sırasında bir hata oluştu.'); }
                    },
                    error: function(){ alert('Güncelleme sırasında bir hata oluştu.'); }
                });
            });

            $(".konut-secim-btn").click(function () {
                $("#kategoriInput").val($(this).text());
                $("#konutFormu").show().find("input, select").prop("disabled", false);
                $("#araziFormu").hide().find("input, select").prop("disabled", true);
                $(".konut-secim-btn, .arazi-secim-btn").removeClass("active");
                $(this).addClass("active");
            });
            $(".arazi-secim-btn").click(function () {
                $("#kategoriInput").val($(this).text());
                $("#araziFormu").show().find("input, select").prop("disabled", false);
                $("#konutFormu").hide().find("input, select").prop("disabled", true);
                $(".arazi-secim-btn, .konut-secim-btn").removeClass("active");
                $(this).addClass("active");
            });

            $("#btnYeniKayit").click(function () {
                $("#yeniKayitModal").modal('show');
                $(".konut-secim-btn").first().click();
            });

            $("#isim, #isimArazi").on('input', function () { $(this).val($(this).val().replace(/[^a-zA-ZığüşöçıİĞÜŞÖÇ\s]/g, '')); });
            $("#ceptel, #ceptelArazi").on('input', function () {
                var digits = $(this).val().replace(/\D/g, '');
                if (digits.length > 0 && digits.charAt(0) !== '0') digits = '0' + digits;
                var f = digits;
                if (digits.length > 4) f = digits.substring(0, 4) + " " + digits.substring(4);
                if (digits.length > 7) f = digits.substring(0, 4) + " " + digits.substring(4, 7) + " " + digits.substring(7);
                if (digits.length > 9) f = digits.substring(0, 4) + " " + digits.substring(4, 7) + " " + digits.substring(7, 9) + " " + digits.substring(9, 11);
                $(this).val(f);
            });
            $("#ada, #parsel, #metrekare, #ilanNo, #odaSayisi, #binaYasi, #binaKatSayisi, #bulunduguKat").on('input', function () { $(this).val($(this).val().replace(/\D/g, '')); });
            $("#fiyat").on('input', function () {
                var digits = $(this).val().replace(/[TLtrl.\s]/g, '').replace(/\D/g, '');
                if (digits === '') { $(this).val(''); return; }
                $(this).val(parseInt(digits, 10).toLocaleString('tr-TR') + " TL");
            });

            $.getJSON("/data/TR-İl-İlçe-Mahalle_(City-County-Neighborhood).json", function (data) {
                data.sort((a, b) => a.Il.localeCompare(b.Il));
                function populateIller(selector) { $(selector).empty().append('<option value="">İl Seçiniz</option>'); data.forEach(il => $(selector).append(new Option(il.Il, il.Il))); }
                populateIller("#il"); populateIller("#ilArazi");
                $("#il, #ilArazi").change(function () {
                    const selectedIlData = data.find(c => c.Il === $(this).val());
                    const ilceSelector = $(this).attr("id") === "il" ? "#ilce" : "#ilceArazi";
                    const mahalleSelector = $(this).attr("id") === "il" ? "#mahalle" : "#mahalleArazi";
                    $(ilceSelector).empty().append('<option value="">İlçe Seçiniz</option>');
                    $(mahalleSelector).empty().append('<option value="">Mahalle/Köy Seçiniz</option>');
                    if (selectedIlData) { selectedIlData.Ilce.sort((a, b) => a.Ilce.localeCompare(b.Ilce)); selectedIlData.Ilce.forEach(ilce => $(ilceSelector).append(new Option(ilce.Ilce, ilce.Ilce))); }
                });
                $("#ilce, #ilceArazi").change(function () {
                    const selectedIl = $(this).attr("id") === "ilce" ? $("#il").val() : $("#ilArazi").val();
                    const selectedIlData = data.find(c => c.Il === selectedIl);
                    const mahalleSelector = $(this).attr("id") === "ilce" ? "#mahalle" : "#mahalleArazi";
                    $(mahalleSelector).empty().append('<option value="">Mahalle/Köy Seçiniz</option>');
                    if (selectedIlData) {
                        const selectedIlceData = selectedIlData.Ilce.find(d => d.Ilce === $(this).val());
                        if (selectedIlceData) {
                            let allMahalleler = [];
                            selectedIlceData.Semt.forEach(semt => allMahalleler.push(...semt.Mahalle.map(m => m.Mahalle)));
                            allMahalleler.sort((a, b) => a.localeCompare(b)).forEach(m => $(mahalleSelector).append(new Option(m, m)));
                        }
                    }
                });
            });

            $("#kaydetBtn").click(function (e) {
                e.preventDefault();
                $.ajax({
                    type: "POST", url: $("#kayitFormu").attr("action"), data: $("#kayitFormu").serialize(),
                    success: function () { $("#yeniKayitModal").modal('hide'); $("#kayitFormu")[0].reset(); window.location.reload(); },
                    error: function () { alert("Kayıt eklenirken bir hata oluştu."); }
                });
            });

            $('#yeniKayitModal').on('hidden.bs.modal', function () {
                $(this).find('form')[0].reset();
                $(".konut-secim-btn, .arazi-secim-btn").removeClass("active");
                $("#konutFormu").show().find("input, select").prop("disabled", false);
                $("#araziFormu").hide().find("input, select").prop("disabled", true);
            });
        });
    </script>
}
