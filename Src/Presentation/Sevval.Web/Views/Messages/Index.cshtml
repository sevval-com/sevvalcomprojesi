@{
    ViewData["Title"] = "Mesajlar";
    var currentUserId = User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? string.Empty;
    var isIndividualUser = User?.Claims?.Any(c =>
        !string.IsNullOrWhiteSpace(c.Value) &&
        c.Value.Contains("Bireysel", System.StringComparison.OrdinalIgnoreCase)) ?? false;
}

<div class="container-fluid p-0 sevval-messages-index" data-me="@currentUserId" data-individual="@isIndividualUser.ToString().ToLowerInvariant()">
    <div class="messages-shell">
        <aside class="messages-filter">
            <div class="filter-header">
                <h2>Mesajlar</h2>
            </div>
            <ul class="filter-list" id="messageFilters">
                @if (!isIndividualUser)
                {
                    <li class="filter-item active" data-type="Own">İlan Mesajlarım</li>
                }
                <li class="filter-item" data-type="Other">İlgilendiğim İlanlar</li>
                <li class="filter-item is-disabled" data-type="Comment" title="Yakında" aria-disabled="true">Yorumlar</li>
                <li class="filter-item is-disabled" data-type="Notification" title="Yakında" aria-disabled="true">Sistem Bildirimleri</li>
            </ul>
        </aside>

        <main class="messages-feed">
            <div class="feed-header">
                <div class="search-wrap">
                    <input type="text" id="messageSearch" placeholder="Mesaj ara">
                </div>
            </div>

            <div class="feed-list" id="messageCardList"></div>
            <div class="feed-footer">
                <button class="btn btn-sm btn-outline-primary d-none" id="loadMoreBtn">Daha fazla yükle</button>
            </div>
        </main>
    </div>
</div>

<style>
    .sevval-messages-index {
        padding-bottom: 0;
        height: calc(100vh - 96px);
        overflow: hidden;
    }
    .messages-shell {
        display: grid;
        grid-template-columns: minmax(240px, 280px) 1fr;
        gap: 1.25rem;
        padding: 24px;
        height: 100%;
        width: 100%;
        margin: 0 auto;
    }
    .messages-filter {
        background: #fff;
        border: 1px solid rgba(13, 110, 253, 0.35);
        border-radius: 16px;
        padding: 16px;
        height: fit-content;
        box-shadow: 0 0 0 1px rgba(13, 110, 253, 0.12), 0 10px 24px rgba(13, 110, 253, 0.08);
    }
    .filter-header {
        margin-bottom: 12px;
    }
    .filter-header h2 {
        font-size: 1.1rem;
        margin: 0 0 12px 0;
    }
    .search-wrap input {
        width: 100%;
        border: 1px solid #e1e6ef;
        border-radius: 12px;
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    .filter-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: grid;
        gap: 8px;
    }
    .filter-item {
        height: 40px;
        padding: 0 0.85rem;
        border-radius: 10px;
        border: 1px solid #e6eaf2;
        background: #f7f9fd;
        cursor: pointer;
        font-weight: 600;
        color: #475569;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        font-size: 0.76rem;
    }
    .sevval-messages-index {
        --tab-own: #0d6efd;
        --tab-other: #6f42c1;
        --tab-comment: #20c997;
        --tab-notif: #fd7e14;
    }
    .filter-item.active[data-type="Own"] {
        background: rgba(13, 110, 253, 0.12);
        border-color: var(--tab-own);
        color: var(--tab-own);
        box-shadow: 0 6px 14px -10px rgba(13,110,253,0.35);
    }
    .filter-item.active[data-type="Other"] {
        background: rgba(111, 66, 193, 0.12);
        border-color: var(--tab-other);
        color: var(--tab-other);
        box-shadow: 0 6px 14px -10px rgba(111,66,193,0.35);
    }
    .filter-item.active[data-type="Comment"] {
        background: rgba(32, 201, 151, 0.12);
        border-color: var(--tab-comment);
        color: var(--tab-comment);
        box-shadow: 0 6px 14px -10px rgba(32,201,151,0.35);
    }
    .filter-item.active[data-type="Notification"] {
        background: rgba(253, 126, 20, 0.12);
        border-color: var(--tab-notif);
        color: var(--tab-notif);
        box-shadow: 0 6px 14px -10px rgba(253,126,20,0.35);
    }
    .sevval-messages-index[data-individual="true"] .unread-badge {
        background: var(--tab-other);
    }
    .filter-item.is-disabled {
        background: #f3f4f6;
        border-color: #e5e7eb;
        color: #9ca3af;
        box-shadow: none;
        cursor: not-allowed;
        opacity: 0.85;
    }

    .messages-feed {
        background: #fff;
        border: 1px solid rgba(13, 110, 253, 0.35);
        border-radius: 16px;
        padding: 20px;
        min-height: 0;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 16px;
        box-shadow: 0 0 0 1px rgba(13, 110, 253, 0.12), 0 10px 24px rgba(13, 110, 253, 0.08);
    }
    .feed-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        border-bottom: 1px solid #eef1f6;
        padding-bottom: 12px;
    }
    .feed-header h3 {
        font-size: 1.05rem;
        margin: 0;
    }
    .feed-list {
        display: flex;
        flex-direction: column;
        gap: 14px;
        overflow-y: auto;
        padding-right: 6px;
        flex: 1;
        min-height: 0;
        max-width: 820px;
        width: 100%;
        margin: 0 auto;
        align-items: stretch;
        align-content: flex-start;
    }
    .feed-footer {
        display: flex;
        justify-content: center;
    }
    .empty-state {
        border: 1px dashed #e1e6ef;
        border-radius: 14px;
        padding: 24px;
        text-align: center;
        color: #94a3b8;
        font-size: 0.9rem;
        background: #f9fbff;
    }
    .message-card {
        border: 1px solid #e6eaf2;
        border-radius: 14px;
        padding: 14px;
        background: #fff;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
        display: grid;
        gap: 12px;
        overflow: hidden;
    }

    @@media (min-width: 1200px) {
        .feed-list {
            gap: 6px;
            max-width: 760px;
        }
        .message-card {
            padding: 10px;
        }
    }
    .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }
    .sender-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: #e8eef9;
        color: #0d6efd;
        display: grid;
        place-items: center;
        font-weight: 700;
        overflow: hidden;
    }
    .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        display: block;
    }
    .sender-info .name {
        font-weight: 600;
        font-size: 0.95rem;
    }
    .sender-info .meta {
        font-size: 0.8rem;
        color: #94a3b8;
    }
    .unread-badge {
        background: #0d6efd;
        color: #fff;
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 999px;
        font-weight: 600;
    }
    .preview {
        font-size: 0.98rem;
        color: #1f2937;
        font-weight: 500;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
        max-height: 2.8em;
    }
    .listing-box {
        background: #f5f7fb;
        border: 1px solid #e6eaf2;
        border-radius: 10px;
        padding: 6px 8px;
        display: grid;
        gap: 2px;
        font-size: 0.72rem;
        color: #64748b;
        overflow: hidden;
    }
    .listing-row {
        display: flex;
        justify-content: space-between;
        gap: 6px;
        min-width: 0;
    }
    .listing-row .label {
        color: #6b7280;
        font-weight: 500;
    }
    .listing-title {
        font-weight: 600;
        color: #64748b;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .listing-price {
        font-weight: 600;
        color: #64748b;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .listing-location {
        color: #64748b;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .card-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
    }
    footer {
        display: none;
    }

    @@media (min-width: 1400px) {
        .messages-shell {
            max-width: 1600px;
            margin: 0 auto;
            padding: 28px 32px;
            grid-template-columns: minmax(260px, 300px) 1fr;
            gap: 1.5rem;
        }
        .messages-filter {
            padding: 18px;
        }
        .preview {
            font-size: 1.02rem;
            color: #111827;
        }
    }

    @@media (min-width: 1200px) and (max-width: 1399px) {
        .preview {
            font-size: 1rem;
            color: #111827;
        }
    }

    @@media (max-width: 1200px) {
        .messages-shell {
            grid-template-columns: minmax(220px, 260px) 1fr;
            padding: 20px;
        }
        .messages-filter {
            padding: 14px;
        }
    }

    @@media (max-width: 992px) {
        .messages-shell {
            grid-template-columns: 1fr;
            padding: 16px;
            height: auto;
        }
        .sevval-messages-index {
            height: auto;
            overflow: visible;
        }
        .feed-header {
            flex-direction: column;
            align-items: flex-start;
        }
        .messages-filter {
            width: 100%;
        }
        .messages-feed {
            width: 100%;
            min-height: 60vh;
            height: auto;
        }
        .feed-list {
            overflow: visible;
            max-height: none;
        }
    }

    @@media (max-width: 768px) {
        .sevval-messages-index {
            height: auto;
            overflow: visible;
        }
        .messages-shell {
            padding: 14px;
            gap: 1rem;
        }
        .feed-header {
            gap: 10px;
        }
        .search-wrap {
            width: 100%;
        }
        .search-wrap input {
            width: 100%;
        }
    }

    @@media (max-width: 576px) {
        .messages-shell {
            padding: 12px;
        }
        .filter-item {
            height: 38px;
            font-size: 0.72rem;
        }
        .feed-header h3 {
            font-size: 1rem;
        }
        .message-card {
            padding: 12px;
        }
    }
</style>

<script>
    const apiBase = "/api/v1/messages";
    const urlParams = new URLSearchParams(window.location.search);

    const typeMap = {
        Own: 0,
        Other: 1,
        Comment: 2,
        Notification: 3
    };

    const rootEl = document.querySelector(".sevval-messages-index");
    const initialType = (urlParams.get("type") || "Own").trim();
    const isIndividual = rootEl?.dataset.individual === "true";
    const resolvedType = (isIndividual && initialType === "Own") ? "Other" : initialType;
    const state = {
        me: urlParams.get("me") || rootEl?.dataset.me || "demo-user",
        activeType: resolvedType,
        search: "",
        conversations: [],
        listingCache: {},
        page: 1,
        pageSize: 20
    };

    const messageFilters = document.getElementById("messageFilters");
    const messageSearch = document.getElementById("messageSearch");
    const messageCardList = document.getElementById("messageCardList");
    const loadMoreBtn = document.getElementById("loadMoreBtn");

    function getInitials(name) {
        if (!name) return "—";
        return name
            .split(" ")
            .filter(Boolean)
            .slice(0, 2)
            .map(part => part[0].toUpperCase())
            .join("");
    }

    function formatDate(value) {
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return "";
        return date.toLocaleDateString("tr-TR", { day: "2-digit", month: "2-digit", timeZone: "Europe/Istanbul" });
    }

    function formatPrice(value) {
        const num = typeof value === "number" ? value : parseFloat(value);
        if (!Number.isFinite(num)) return "—";
        return `${num.toLocaleString("tr-TR")} ₺`;
    }

    function normalizeApiData(data) {
        return data && (data.data || data.Data || data) ? (data.data || data.Data || data) : null;
    }

    async function fetchJson(url) {
        const response = await fetch(url, { cache: "no-store" });
        if (!response.ok) throw new Error("İstek başarısız");
        return await response.json();
    }

    async function loadConversations() {
        const params = new URLSearchParams({
            UserId: state.me,
            MessageType: typeMap[state.activeType].toString()
        });
        const data = await fetchJson(`${apiBase}/conversations?${params.toString()}`);
        state.conversations = (data.items || []).map(item => ({
            otherUserId: item.otherUserId,
            name: item.otherUserFullName || item.otherUserEmail || item.otherUserId,
            avatarUrl: item.otherUserAvatarUrl || "",
            preview: item.lastMessagePreview || "—",
            time: item.lastMessageAtUtc,
            listingId: item.listingId ?? null,
            unread: item.unreadCount || 0,
            messageType: item.messageType || state.activeType
        })).sort((a, b) => new Date(b.time || 0) - new Date(a.time || 0));
        state.page = 1;
        renderCards();
    }

    function renderCards() {
        messageCardList.innerHTML = "";
        const query = state.search.toLowerCase();
        const items = state.conversations.filter(conv =>
            conv.name.toLowerCase().includes(query) || conv.preview.toLowerCase().includes(query)
        );
        const sliceEnd = state.page * state.pageSize;
        const pagedItems = items.slice(0, sliceEnd);

        if (!pagedItems.length) {
            messageCardList.innerHTML = '<div class="empty-state">Henüz mesajınız bulunmamaktadır.</div>';
            loadMoreBtn.classList.add("d-none");
            return;
        }

        pagedItems.forEach(conv => {
            const card = document.createElement("div");
            card.className = "message-card";
            const badgeHtml = conv.unread > 0
                ? `<span class="unread-badge">${conv.unread}</span>`
                : "";
            card.innerHTML = `
                <div class="card-header">
                    <div class="sender-info">
                        <div class="avatar">
                            ${conv.avatarUrl ? `<img src="${conv.avatarUrl}" alt="">` : getInitials(conv.name)}
                        </div>
                        <div>
                            <div class="name">${conv.name}</div>
                            <div class="meta">${formatDate(conv.time)}</div>
                        </div>
                    </div>
                    ${badgeHtml}
                </div>
                <div class="preview">${conv.preview}</div>
                <div class="listing-box" data-listing-id="${conv.listingId ?? ""}">
                    <div class="listing-row">
                        <span class="value listing-title">—</span>
                    </div>
                    <div class="listing-row">
                        <span class="value listing-price">—</span>
                    </div>
                    <div class="listing-row">
                        <span class="value listing-location">—</span>
                    </div>
                </div>
                <div class="card-actions">
                    <a class="btn btn-sm btn-outline-primary" href="/messaging?me=${encodeURIComponent(state.me)}&other=${encodeURIComponent(conv.otherUserId)}&type=${encodeURIComponent(conv.messageType)}${conv.listingId ? `&listingId=${conv.listingId}` : ""}">Mesajı Gör</a>
                </div>
            `;
            messageCardList.appendChild(card);
            hydrateListing(card, conv.listingId);
        });

        if (items.length > sliceEnd) {
            loadMoreBtn.classList.remove("d-none");
        } else {
            loadMoreBtn.classList.add("d-none");
        }
    }

    async function hydrateListing(card, listingId) {
        if (!listingId) {
            const title = card.querySelector(".listing-title");
            if (title) title.textContent = "İlan bilgisi yok";
            return;
        }

        if (state.listingCache[listingId]) {
            applyListing(card, state.listingCache[listingId]);
            return;
        }

        try {
            const response = await fetchJson(`/api/v1/announcements/${listingId}`);
            const payload = normalizeApiData(response);
            const announcement = payload && (payload.announcement || payload.Announcement);
            if (!announcement) return;
            const data = {
                title: announcement.title ?? announcement.Title,
                price: announcement.price ?? announcement.Price,
                sehir: announcement.sehir ?? announcement.Sehir,
                semt: announcement.semt ?? announcement.Semt
            };
            state.listingCache[listingId] = data;
            applyListing(card, data);
        } catch (error) {
            const title = card.querySelector(".listing-title");
            if (title) title.textContent = "İlan bilgisi yok";
        }
    }

    function applyListing(card, listing) {
        const title = card.querySelector(".listing-title");
        const price = card.querySelector(".listing-price");
        const location = card.querySelector(".listing-location");
        if (title) title.textContent = listing.title || "—";
        if (price) price.textContent = formatPrice(listing.price);
        const loc = listing.sehir ? (listing.semt ? `${listing.sehir} / ${listing.semt}` : listing.sehir) : "—";
        if (location) location.textContent = loc;
    }

    messageFilters.addEventListener("click", event => {
        const item = event.target.closest(".filter-item");
        if (!item) return;
        if (item.classList.contains("is-disabled")) {
            return;
        }
        messageFilters.querySelectorAll(".filter-item").forEach(btn => btn.classList.remove("active"));
        item.classList.add("active");
        state.activeType = item.dataset.type;
        const url = new URL(window.location.href);
        url.searchParams.set("type", state.activeType);
        window.history.replaceState({}, "", `${url.pathname}?${url.searchParams.toString()}`);
        state.page = 1;
        loadConversations();
    });

    messageSearch.addEventListener("input", event => {
        state.search = event.target.value || "";
        state.page = 1;
        renderCards();
    });

    async function refreshOnReturn() {
        if (!document.hidden) {
            await loadConversations();
        }
    }

    document.addEventListener("visibilitychange", refreshOnReturn);
    window.addEventListener("focus", refreshOnReturn);

    loadMoreBtn.addEventListener("click", () => {
        state.page += 1;
        renderCards();
    });

    (function initFilters() {
        const fallbackType = isIndividual ? "Other" : "Own";
        const type = (state.activeType && typeMap[state.activeType] !== undefined) ? state.activeType : fallbackType;
        state.activeType = type;
        messageFilters.querySelectorAll(".filter-item").forEach(btn => {
            btn.classList.toggle("active", btn.dataset.type === state.activeType);
        });
    })();

    loadConversations();
</script>
